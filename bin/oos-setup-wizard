#!/usr/bin/env bash
# OOS Complete Setup Wizard
# Run ONCE per machine - configures EVERYTHING

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
OOS_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Load common functions
source "$OOS_ROOT/lib/oos-common.sh" 2>/dev/null || true

# Config location (user's home, not project)
OOS_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/oos"
OOS_CREDENTIALS="$OOS_CONFIG_DIR/credentials"

mkdir -p "$OOS_CONFIG_DIR"
chmod 700 "$OOS_CONFIG_DIR"

oos_log_header "OOS Complete Setup Wizard"
echo "This runs ONCE per machine and configures EVERYTHING."
echo "After this, all OOS features work in all projects."
echo ""

# Check if already configured
if [[ -f "$OOS_CREDENTIALS" ]]; then
    oos_log_warning "OOS is already configured"
    echo ""
    read -p "Reconfigure? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        oos_log_info "Keeping existing configuration"
        exit 0
    fi
fi

oos_log_header "1. Core Setup (Required)"

# Python environment
oos_log_info "Checking Python environment..."
if ! command -v uv &>/dev/null; then
    oos_log_info "Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    export PATH="$HOME/.cargo/bin:$PATH"
fi
oos_log_success "Python environment: Ready"

# Install dependencies if in OOS repo
if [[ -f "$OOS_ROOT/pyproject.toml" ]]; then
    cd "$OOS_ROOT"
    oos_log_info "Installing OOS dependencies..."
    uv sync
    oos_log_success "Dependencies installed"
fi

oos_log_header "2. AI Features (Your Workflow)"

echo "Choose AI provider (you'll use this constantly):"
echo "  1) OpenRouter (recommended - access to many models)"
echo "  2) OpenAI"
echo "  3) Anthropic"
echo ""
read -p "Choice (1-3): " ai_choice

case "$ai_choice" in
    1)
        echo ""
        echo "Get your OpenRouter API key:"
        echo "  1. Visit: https://openrouter.ai"
        echo "  2. Sign up / Log in"
        echo "  3. Go to Keys section"
        echo "  4. Create new key"
        echo ""
        read -p "OpenRouter API Key: " -s openrouter_key
        echo ""
        echo "OPENROUTER_API_KEY=$openrouter_key" >> "$OOS_CREDENTIALS"
        oos_log_success "OpenRouter configured"
        ;;
    2)
        echo ""
        read -p "OpenAI API Key: " -s openai_key
        echo ""
        echo "OPENAI_API_KEY=$openai_key" >> "$OOS_CREDENTIALS"
        oos_log_success "OpenAI configured"
        ;;
    3)
        echo ""
        read -p "Anthropic API Key: " -s anthropic_key
        echo ""
        echo "ANTHROPIC_API_KEY=$anthropic_key" >> "$OOS_CREDENTIALS"
        oos_log_success "Anthropic configured"
        ;;
esac

oos_log_header "3. Archon Knowledge Base (Your Brain)"

echo "Archon stores your knowledge across all projects."
echo ""
read -p "Do you have Archon running? (Y/n) " -n 1 -r
echo

if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
    read -p "Archon URL [https://archon.khamel.com]: " archon_url
    archon_url="${archon_url:-https://archon.khamel.com}"

    read -p "Archon API Key (if required): " archon_key

    # Test connection
    oos_log_info "Testing Archon connection..."
    if curl -sf "${archon_url}/api/health" &>/dev/null; then
        echo "ARCHON_URL=$archon_url" >> "$OOS_CREDENTIALS"
        [[ -n "$archon_key" ]] && echo "ARCHON_API_KEY=$archon_key" >> "$OOS_CREDENTIALS"
        oos_log_success "Archon connected and tested"
    else
        oos_log_warning "Archon not reachable at $archon_url"
        echo "# ARCHON_URL=$archon_url (not reachable)" >> "$OOS_CREDENTIALS"
    fi
else
    oos_log_info "Skipping Archon (can configure later with: oos setup archon)"
    echo "# Archon not configured" >> "$OOS_CREDENTIALS"
fi

oos_log_header "4. Deployment Setup (Your Workflow)"

echo "Configure deployment targets (you'll use these constantly):"
echo ""

# Vercel
read -p "Setup Vercel deployment? (Y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
    if ! command -v vercel &>/dev/null; then
        oos_log_info "Installing Vercel CLI..."
        npm install -g vercel
    fi

    oos_log_info "Login to Vercel..."
    vercel login

    oos_log_success "Vercel configured"
    echo "VERCEL_CONFIGURED=true" >> "$OOS_CREDENTIALS"
fi

# OCI VM
echo ""
read -p "Setup OCI VM deployment? (Y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
    read -p "OCI VM IP: " oci_ip
    read -p "SSH User: " oci_user
    read -p "SSH Key Path [~/.ssh/oci_key]: " oci_key
    oci_key="${oci_key:-$HOME/.ssh/oci_key}"

    # Test SSH
    oos_log_info "Testing OCI connection..."
    if ssh -o ConnectTimeout=5 -i "$oci_key" "$oci_user@$oci_ip" "echo 'OK'" &>/dev/null; then
        echo "OCI_VM_IP=$oci_ip" >> "$OOS_CREDENTIALS"
        echo "OCI_SSH_USER=$oci_user" >> "$OOS_CREDENTIALS"
        echo "OCI_SSH_KEY=$oci_key" >> "$OOS_CREDENTIALS"
        oos_log_success "OCI VM connected and tested"
    else
        oos_log_warning "OCI connection failed - check SSH key and permissions"
        echo "# OCI_VM_IP=$oci_ip (connection failed)" >> "$OOS_CREDENTIALS"
    fi
fi

# Secure the credentials file
chmod 600 "$OOS_CREDENTIALS"

oos_log_header "Setup Complete!"
echo ""
echo "All OOS features configured and ready to use."
echo "Configuration saved to: $OOS_CREDENTIALS"
echo ""
echo "Test your setup:"
echo "  oos status              # Check what's working"
echo "  oos ai analyze 'test'   # Test AI"
echo "  oos archon status       # Test Archon"
echo ""
echo "These settings work in ALL projects now."
echo "You should never need to configure OOS again."
